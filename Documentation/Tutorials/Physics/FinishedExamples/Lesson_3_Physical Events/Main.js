"use strict";
//Reference Fudge, getting code completion ready and creating a shortcut f to write FudgeCode more comfortably
var Tutorials_FUDGEPhysics_Lesson1;
//Reference Fudge, getting code completion ready and creating a shortcut f to write FudgeCode more comfortably
(function (Tutorials_FUDGEPhysics_Lesson1) {
    var f = FudgeCore;
    //Goal: Learn how to create and use physics based events (Collision/Trigger) to control nodes in the app.
    //Fudge Basic Variables
    window.addEventListener("load", init);
    const app = document.querySelector("canvas"); // The html element where the scene is drawn to
    let viewPort; // The scene visualization
    let hierarchy; // You're object scene tree
    //Physical Objects
    let bodies = new Array(); // Array of all physical objects in the scene to have a quick reference
    let playerBody; // Transform of a body that interacts with physics but can be moved by normal FudgeTransform
    //Setting Variables
    let force = 0.5; //The amount of movement with each keypress
    let playerDefaultMat = new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0, 0, 1, 1)));
    let playerTriggeredMat = new f.Material("CubeTriggered", f.ShaderFlat, new f.CoatColored(new f.Color(0.9, 0.1, 0.1, 1)));
    //Function to initialize the Fudge Scene with a camera, light, viewport and PHYSCIAL Objects
    function init(_event) {
        hierarchy = new f.Node("Scene"); //create the root Node where every object is parented to. Should never be changed
        //#region PHYSICS
        //PHYSICS - Step 2: Create some physical Nodes to play with 
        //Creating a physically static ground plane for our physics playground. A simple scaled cube but with physics type set to static
        bodies[0] = createCompleteNode("Ground", new f.Material("Ground", f.ShaderFlat, new f.CoatColored(new f.Color(0.2, 0.2, 0.2, 1))), new f.MeshCube(), 0, f.PHYSICS_TYPE.STATIC);
        bodies[0].mtxLocal.scale(new f.Vector3(14, 0.3, 14)); //Scale the body with it's standard ComponentTransform
        bodies[0].mtxLocal.rotateX(4, true); //Give it a slight rotation so the physical objects are sliding, always from left when it's after a scaling
        hierarchy.appendChild(bodies[0]); //Add the node to the scene by adding it to the scene-root
        //Step 1 - Creating a the player cube - to interact to trigger, COLLIDERS and TRIGGERS 
        bodies[1] = createCompleteNode("Player", playerDefaultMat, new f.MeshCube(), 1, f.PHYSICS_TYPE.DYNAMIC);
        playerBody = bodies[1]; //Reference this node specifically so we can access it for input more easily
        playerBody.mtxLocal.translate(new f.Vector3(0, 1, 0));
        hierarchy.appendChild(bodies[1]);
        playerBody.getComponent(f.ComponentRigidbody).rotationInfluenceFactor = new f.Vector3(0, 0, 0); //make rotation fixed the player does not rotate
        playerBody.getComponent(f.ComponentRigidbody).friction = 1;
        //Step 2 - Create bodies - one used as a button when it collides it will an action will happen - one as a trigger, when it's overlapping it will trigger an action
        //The Collision Event is happening on a collision so a normal body can receive it
        //A use case for a collision event is for example when the player is hitting the ground to play a sound
        bodies[2] = createCompleteNode("Collider_Button", new f.Material("Collider_Button", f.ShaderFlat, new f.CoatColored(new f.Color(0.3, 0.3, 0.4, 1))), new f.MeshCube(), 1, f.PHYSICS_TYPE.STATIC);
        bodies[2].mtxLocal.translate(new f.Vector3(-3, 1, 0));
        hierarchy.appendChild(bodies[2]);
        //The Trigger Event is happening when bodies overlap, so we need a special body that does not collide but overlap
        //So it must be flagged as trigger, and normally in games it's invisble, so it has no mesh component or is fully transparent.
        //A use case is something like spawning enemies when a player enters a room.
        bodies[3] = createCompleteNode("Trigger_Button", new f.Material("Trigger_Button", f.ShaderFlat, new f.CoatColored(new f.Color(0.5, 0.3, 0.2, 0.3))), new f.MeshCube(), 1, f.PHYSICS_TYPE.STATIC, f.PHYSICS_GROUP.DEFAULT);
        bodies[3].mtxLocal.translate(new f.Vector3(3, 1, 0));
        bodies[3].getComponent(f.ComponentRigidbody).isTrigger = true;
        hierarchy.appendChild(bodies[3]);
        //Trigger when player is falling of the plane
        bodies[4] = createCompleteNode("Trigger_Reset", new f.Material("Trigger_Reset", f.ShaderFlat, new f.CoatColored(new f.Color(0.5, 0.3, 0.2, 0.3))), new f.MeshCube(), 1, f.PHYSICS_TYPE.STATIC, f.PHYSICS_GROUP.DEFAULT);
        bodies[4].getComponent(f.ComponentRigidbody).isTrigger = true;
        bodies[4].removeComponent(bodies[4].getComponent(f.ComponentMesh)); //removing the mesh to have invisible trigger - standard practice
        bodies[4].mtxLocal.translate(new f.Vector3(0, -4, 0));
        bodies[4].mtxLocal.scale(new f.Vector3(30, 1, 30)); //Make it big enough so the player should hit it
        hierarchy.appendChild(bodies[4]);
        //Step 3 - After creating our Physic Event Bodies, we tell them to listen to the specific event happening
        //These events are happening on the physic component not on the node. So be sure to add them to the component not to the node
        //A body can receive a enter/exit event, and it's only happening once. If a body is staying on a collision or in a trigger it needs to be handled manually
        bodies[2].getComponent(f.ComponentRigidbody).addEventListener("ColliderEnteredCollision" /* COLLISION_ENTER */, hndCollisionEventEnter);
        bodies[2].getComponent(f.ComponentRigidbody).addEventListener("ColliderLeftCollision" /* COLLISION_EXIT */, hndCollisionEventExit);
        /*Hint: The Collision Event is only happening if the object is hitting it physically,
          So KINEMATIC vs. STATIC does not receive a collision Event. Only DYNAMIC vs. DYNAMIC/STATIC/KINEMATIC, neither do two Kinematic hit each other nor do Kinematic/Static.
          If you really need a kinematic hitting a static object and still have a action, use trigger, or make the object not static but dynamic but unmoving by having a ridiculously high weight.
          Thats why we use a dynamic player cube instead of a kinematic like we did in Lesson 1.
        */
        //Same as for collision a trigger is also listening on a event type in form of f.EVENT_PHYSICS and a function that will be called
        bodies[3].getComponent(f.ComponentRigidbody).addEventListener("TriggerEnteredCollision" /* TRIGGER_ENTER */, hndTriggerEventEnter);
        bodies[3].getComponent(f.ComponentRigidbody).addEventListener("TriggerLeftCollision" /* TRIGGER_EXIT */, hndTriggerEventExit);
        //Setting up our reset
        bodies[4].getComponent(f.ComponentRigidbody).addEventListener("TriggerEnteredCollision" /* TRIGGER_ENTER */, hndResetTrigger);
        //#endregion PHYSICS
        //Standard Fudge Scene Initialization - Creating a directional light, a camera and initialize the viewport
        let cmpLight = new f.ComponentLight(new f.LightDirectional(f.Color.CSS("WHITE")));
        cmpLight.mtxPivot.lookAt(new f.Vector3(0.5, -1, -0.8)); //Set light direction
        hierarchy.addComponent(cmpLight);
        let cmpCamera = new f.ComponentCamera();
        cmpCamera.clrBackground = f.Color.CSS("GREY");
        cmpCamera.mtxPivot.translate(new f.Vector3(2, 3.5, 17)); //Move camera far back so the whole scene is visible
        cmpCamera.mtxPivot.lookAt(f.Vector3.ZERO()); //Set the camera matrix so that it looks at the center of the scene
        viewPort = new f.Viewport(); //Creating a viewport that is rendered onto the html canvas element
        viewPort.initialize("Viewport", hierarchy, cmpCamera, app); //initialize the viewport with the root node, camera and canvas
        document.addEventListener("keypress", hndKey); //Adding a listener for keypress handling
        //PHYSICS - Start using physics by telling the physics the scene root object. Physics will recalculate every transform and initialize
        f.Physics.adjustTransforms(hierarchy);
        //Important start the game loop after starting physics, so physics can use the current transform before it's first iteration
        f.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update); //Tell the game loop to call the update function on each frame
        f.Loop.start(); //Stard the game loop
    }
    //Function to animate/update the Fudge scene, commonly known as gameloop
    function update() {
        f.Physics.world.simulate(); //PHYSICS - Simulate physical changes each frame, parameter to set time between frames
        viewPort.draw(); // Draw the current Fudge Scene to the canvas
    }
    // Function to quickly create a node with multiple needed FudgeComponents, including a physics component
    function createCompleteNode(_name, _material, _mesh, _mass, _physicsType, _group = f.PHYSICS_GROUP.DEFAULT, _colType = f.COLLIDER_TYPE.CUBE) {
        let node = new f.Node(_name); //Creating the node
        let cmpMesh = new f.ComponentMesh(_mesh); //Creating a mesh for the node
        let cmpMaterial = new f.ComponentMaterial(_material); //Creating a material for the node
        let cmpTransform = new f.ComponentTransform(); //Transform holding position/rotation/scaling of the node
        let cmpRigidbody = new f.ComponentRigidbody(_mass, _physicsType, _colType, _group); //<-- adding the group when using triggers, since a trigger should not collide with anything else
        node.addComponent(cmpMesh);
        node.addComponent(cmpMaterial);
        node.addComponent(cmpTransform);
        node.addComponent(cmpRigidbody); // <-- best practice to add physics component last
        return node; //return the full created node
    }
    // Event Function handling keyboard input - similar to Lesson 1 but a little different, since it's pushing the player by force
    function hndKey(_event) {
        let horizontal = 0; //left/right
        let vertical = 0; //front/back
        let height = 0; //upwards/downwards
        //Check keyboard input from Event
        if (_event.code == f.KEYBOARD_CODE.A) {
            horizontal -= force;
        }
        if (_event.code == f.KEYBOARD_CODE.D) {
            horizontal += force;
        }
        if (_event.code == f.KEYBOARD_CODE.W) {
            vertical -= force;
        }
        if (_event.code == f.KEYBOARD_CODE.S) {
            vertical += force;
        }
        if (_event.code == f.KEYBOARD_CODE.SPACE) { //Jump
            height += force * 10;
        }
        playerBody.getComponent(f.ComponentRigidbody).applyLinearImpulse(new f.Vector3(horizontal, height, vertical));
    }
    //Step 4 - Receiving and handling the events
    //Event function handling collision - A EVENT_PHYSICS is receiving a f.EventPhysics with infos about the event
    function hndCollisionEventEnter(_event) {
        //_event. keeps a plethora of informations about the event the most interesting are things like 
        /*
          _event.cmpRigidbody -> to identify the body involved in the event, with getContainer().name you get the actual name of the node involved
          _event.normalImpulse -> intensity of the collision good to play a sound that is only as heavy as the collision
          _event.collisionPoint -> the point in the world where the collision is happening to maybe spawn things like particles
          _event.collisionNormal -> the direction the collision is happening often used to correctly rotate spawned things on the colliding surface
        */
        if (_event.cmpRigidbody.getContainer().name == "Player") { //Our Event is happening with the body NODE called "Player"
            f.Debug.log("Player hit me - Collider");
            //We let this collider act like a bumper through this event. We take the event normal and shoot the player away from the bumper on the contact point.
            playerBody.getComponent(f.ComponentRigidbody).applyForceAtPoint(new f.Vector3(_event.collisionNormal.x * 500, _event.collisionNormal.y * 500, _event.collisionNormal.z * 500), _event.collisionPoint);
        }
    }
    function hndCollisionEventExit(_event) {
        if (_event.cmpRigidbody.getContainer().name == "Player") {
            f.Debug.log("Player left me - Collider");
        }
    }
    //Event function handling triggering
    function hndTriggerEventEnter(_event) {
        if (_event.cmpRigidbody.getContainer().name == "Player") {
            f.Debug.log("Player entered me - Trigger");
            playerBody.getComponent(f.ComponentMaterial).material = playerTriggeredMat;
        }
    }
    function hndTriggerEventExit(_event) {
        if (_event.cmpRigidbody.getContainer().name == "Player") {
            f.Debug.log("Player left me - Trigger");
            playerBody.getComponent(f.ComponentMaterial).material = playerDefaultMat;
        }
    }
    //Since the player could fall of we will reset him back with a trigger when he falls down from the plane
    function hndResetTrigger(_event) {
        if (_event.cmpRigidbody.getContainer().name == "Player") {
            playerBody.getComponent(f.ComponentRigidbody).setPosition(new f.Vector3(0, 3, 0)); //Since it's a physics body we have to set position through physics not transform
        }
    }
})(Tutorials_FUDGEPhysics_Lesson1 || (Tutorials_FUDGEPhysics_Lesson1 = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk1haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDhHQUE4RztBQUU5RyxJQUFVLDhCQUE4QixDQTJNdkM7QUE3TUQsOEdBQThHO0FBRTlHLFdBQVUsOEJBQThCO0lBQ3BDLElBQU8sQ0FBQyxHQUFHLFNBQVMsQ0FBQztJQUVyQix5R0FBeUc7SUFFekcsdUJBQXVCO0lBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQXNCLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQywrQ0FBK0M7SUFDaEgsSUFBSSxRQUFvQixDQUFDLENBQUMsMEJBQTBCO0lBQ3BELElBQUksU0FBaUIsQ0FBQyxDQUFDLDJCQUEyQjtJQUdsRCxrQkFBa0I7SUFDbEIsSUFBSSxNQUFNLEdBQWEsSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLHVFQUF1RTtJQUMzRyxJQUFJLFVBQWtCLENBQUMsQ0FBQyw0RkFBNEY7SUFHcEgsbUJBQW1CO0lBQ25CLElBQUksS0FBSyxHQUFXLEdBQUcsQ0FBQyxDQUFDLDJDQUEyQztJQUNwRSxJQUFJLGdCQUFnQixHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwSCxJQUFJLGtCQUFrQixHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxF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IEZ1ZGdlLCBnZXR0aW5nIGNvZGUgY29tcGxldGlvbiByZWFkeSBhbmQgY3JlYXRpbmcgYSBzaG9ydGN1dCBmIHRvIHdyaXRlIEZ1ZGdlQ29kZSBtb3JlIGNvbWZvcnRhYmx5XG5cbm5hbWVzcGFjZSBUdXRvcmlhbHNfRlVER0VQaHlzaWNzX0xlc3NvbjEge1xuICAgIGltcG9ydCBmID0gRnVkZ2VDb3JlO1xuXG4gICAgLy9Hb2FsOiBMZWFybiBob3cgdG8gY3JlYXRlIGFuZCB1c2UgcGh5c2ljcyBiYXNlZCBldmVudHMgKENvbGxpc2lvbi9UcmlnZ2VyKSB0byBjb250cm9sIG5vZGVzIGluIHRoZSBhcHAuXG5cbiAgICAvL0Z1ZGdlIEJhc2ljIFZhcmlhYmxlc1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLCBpbml0KTtcbiAgICBjb25zdCBhcHA6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcImNhbnZhc1wiKTsgLy8gVGhlIGh0bWwgZWxlbWVudCB3aGVyZSB0aGUgc2NlbmUgaXMgZHJhd24gdG9cbiAgICBsZXQgdmlld1BvcnQ6IGYuVmlld3BvcnQ7IC8vIFRoZSBzY2VuZSB2aXN1YWxpemF0aW9uXG4gICAgbGV0IGhpZXJhcmNoeTogZi5Ob2RlOyAvLyBZb3UncmUgb2JqZWN0IHNjZW5lIHRyZWVcblxuXG4gICAgLy9QaHlzaWNhbCBPYmplY3RzXG4gICAgbGV0IGJvZGllczogZi5Ob2RlW10gPSBuZXcgQXJyYXkoKTsgLy8gQXJyYXkgb2YgYWxsIHBoeXNpY2FsIG9iamVjdHMgaW4gdGhlIHNjZW5lIHRvIGhhdmUgYSBxdWljayByZWZlcmVuY2VcbiAgICBsZXQgcGxheWVyQm9keTogZi5Ob2RlOyAvLyBUcmFuc2Zvcm0gb2YgYSBib2R5IHRoYXQgaW50ZXJhY3RzIHdpdGggcGh5c2ljcyBidXQgY2FuIGJlIG1vdmVkIGJ5IG5vcm1hbCBGdWRnZVRyYW5zZm9ybVxuXG5cbiAgICAvL1NldHRpbmcgVmFyaWFibGVzXG4gICAgbGV0IGZvcmNlOiBudW1iZXIgPSAwLjU7IC8vVGhlIGFtb3VudCBvZiBtb3ZlbWVudCB3aXRoIGVhY2gga2V5cHJlc3NcbiAgICBsZXQgcGxheWVyRGVmYXVsdE1hdDogZi5NYXRlcmlhbCA9IG5ldyBmLk1hdGVyaWFsKFwiQ3ViZVwiLCBmLlNoYWRlckZsYXQsIG5ldyBmLkNvYXRDb2xvcmVkKG5ldyBmLkNvbG9yKDAsIDAsIDEsIDEpKSk7XG4gICAgbGV0IHBsYXllclRyaWdnZXJlZE1hdDogZi5NYXRlcmlhbCA9IG5ldyBmLk1hdGVyaWFsKFwiQ3ViZVRyaWdnZXJlZFwiLCBmLlNoYWRlckZsYXQsIG5ldyBmLkNvYXRDb2xvcmVkKG5ldyBmLkNvbG9yKDAuOSwgMC4xLCAwLjEsIDEpKSk7XG5cbiAgICAvL0Z1bmN0aW9uIHRvIGluaXRpYWxpemUgdGhlIEZ1ZGdlIFNjZW5lIHdpdGggYSBjYW1lcmEsIGxpZ2h0LCB2aWV3cG9ydCBhbmQgUEhZU0NJQUwgT2JqZWN0c1xuICAgIGZ1bmN0aW9uIGluaXQoX2V2ZW50OiBFdmVudCk6IHZvaWQge1xuXG4gICAgICAgIGhpZXJhcmNoeSA9IG5ldyBmLk5vZGUoXCJTY2VuZVwiKTsgLy9jcmVhdGUgdGhlIHJvb3QgTm9kZSB3aGVyZSBldmVyeSBvYmplY3QgaXMgcGFyZW50ZWQgdG8uIFNob3VsZCBuZXZlciBiZSBjaGFuZ2VkXG5cbiAgICAgICAgLy8jcmVnaW9uIFBIWVNJQ1NcblxuICAgICAgICAvL1BIWVNJQ1MgLSBTdGVwIDI6IENyZWF0ZSBzb21lIHBoeXNpY2FsIE5vZGVzIHRvIHBsYXkgd2l0aCBcbiAgICAgICAgLy9DcmVhdGluZyBhIHBoeXNpY2FsbHkgc3RhdGljIGdyb3VuZCBwbGFuZSBmb3Igb3VyIHBoeXNpY3MgcGxheWdyb3VuZC4gQSBzaW1wbGUgc2NhbGVkIGN1YmUgYnV0IHdpdGggcGh5c2ljcyB0eXBlIHNldCB0byBzdGF0aWNcbiAgICAgICAgYm9kaWVzWzBdID0gY3JlYXRlQ29tcGxldGVOb2RlKFwiR3JvdW5kXCIsIG5ldyBmLk1hdGVyaWFsKFwiR3JvdW5kXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMC4yLCAwLjIsIDAuMiwgMSkpKSwgbmV3IGYuTWVzaEN1YmUoKSwgMCwgZi5QSFlTSUNTX1RZUEUuU1RBVElDKTtcbiAgICAgICAgYm9kaWVzWzBdLm10eExvY2FsLnNjYWxlKG5ldyBmLlZlY3RvcjMoMTQsIDAuMywgMTQpKTsgLy9TY2FsZSB0aGUgYm9keSB3aXRoIGl0J3Mgc3RhbmRhcmQgQ29tcG9uZW50VHJhbnNmb3JtXG4gICAgICAgIGJvZGllc1swXS5tdHhMb2NhbC5yb3RhdGVYKDQsIHRydWUpOyAvL0dpdmUgaXQgYSBzbGlnaHQgcm90YXRpb24gc28gdGhlIHBoeXNpY2FsIG9iamVjdHMgYXJlIHNsaWRpbmcsIGFsd2F5cyBmcm9tIGxlZnQgd2hlbiBpdCdzIGFmdGVyIGEgc2NhbGluZ1xuICAgICAgICBoaWVyYXJjaHkuYXBwZW5kQ2hpbGQoYm9kaWVzWzBdKTsgLy9BZGQgdGhlIG5vZGUgdG8gdGhlIHNjZW5lIGJ5IGFkZGluZyBpdCB0byB0aGUgc2NlbmUtcm9vdFxuXG4gICAgICAgIC8vU3RlcCAxIC0gQ3JlYXRpbmcgYSB0aGUgcGxheWVyIGN1YmUgLSB0byBpbnRlcmFjdCB0byB0cmlnZ2VyLCBDT0xMSURFUlMgYW5kIFRSSUdHRVJTIFxuICAgICAgICBib2RpZXNbMV0gPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJQbGF5ZXJcIiwgcGxheWVyRGVmYXVsdE1hdCwgbmV3IGYuTWVzaEN1YmUoKSwgMSwgZi5QSFlTSUNTX1RZUEUuRFlOQU1JQyk7XG4gICAgICAgIHBsYXllckJvZHkgPSBib2RpZXNbMV07IC8vUmVmZXJlbmNlIHRoaXMgbm9kZSBzcGVjaWZpY2FsbHkgc28gd2UgY2FuIGFjY2VzcyBpdCBmb3IgaW5wdXQgbW9yZSBlYXNpbHlcbiAgICAgICAgcGxheWVyQm9keS5tdHhMb2NhbC50cmFuc2xhdGUobmV3IGYuVmVjdG9yMygwLCAxLCAwKSk7XG4gICAgICAgIGhpZXJhcmNoeS5hcHBlbmRDaGlsZChib2RpZXNbMV0pO1xuICAgICAgICBwbGF5ZXJCb2R5LmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkucm90YXRpb25JbmZsdWVuY2VGYWN0b3IgPSBuZXcgZi5WZWN0b3IzKDAsIDAsIDApOyAvL21ha2Ugcm90YXRpb24gZml4ZWQgdGhlIHBsYXllciBkb2VzIG5vdCByb3RhdGVcbiAgICAgICAgcGxheWVyQm9keS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmZyaWN0aW9uID0gMTtcblxuICAgICAgICAvL1N0ZXAgMiAtIENyZWF0ZSBib2RpZXMgLSBvbmUgdXNlZCBhcyBhIGJ1dHRvbiB3aGVuIGl0IGNvbGxpZGVzIGl0IHdpbGwgYW4gYWN0aW9uIHdpbGwgaGFwcGVuIC0gb25lIGFzIGEgdHJpZ2dlciwgd2hlbiBpdCdzIG92ZXJsYXBwaW5nIGl0IHdpbGwgdHJpZ2dlciBhbiBhY3Rpb25cbiAgICAgICAgLy9UaGUgQ29sbGlzaW9uIEV2ZW50IGlzIGhhcHBlbmluZyBvbiBhIGNvbGxpc2lvbiBzbyBhIG5vcm1hbCBib2R5IGNhbiByZWNlaXZlIGl0XG4gICAgICAgIC8vQSB1c2UgY2FzZSBmb3IgYSBjb2xsaXNpb24gZXZlbnQgaXMgZm9yIGV4YW1wbGUgd2hlbiB0aGUgcGxheWVyIGlzIGhpdHRpbmcgdGhlIGdyb3VuZCB0byBwbGF5IGEgc291bmRcbiAgICAgICAgYm9kaWVzWzJdID0gY3JlYXRlQ29tcGxldGVOb2RlKFwiQ29sbGlkZXJfQnV0dG9uXCIsIG5ldyBmLk1hdGVyaWFsKFwiQ29sbGlkZXJfQnV0dG9uXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMC4zLCAwLjMsIDAuNCwgMSkpKSwgbmV3IGYuTWVzaEN1YmUoKSwgMSwgZi5QSFlTSUNTX1RZUEUuU1RBVElDKTtcbiAgICAgICAgYm9kaWVzWzJdLm10eExvY2FsLnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKC0zLCAxLCAwKSk7XG4gICAgICAgIGhpZXJhcmNoeS5hcHBlbmRDaGlsZChib2RpZXNbMl0pO1xuXG4gICAgICAgIC8vVGhlIFRyaWdnZXIgRXZlbnQgaXMgaGFwcGVuaW5nIHdoZW4gYm9kaWVzIG92ZXJsYXAsIHNvIHdlIG5lZWQgYSBzcGVjaWFsIGJvZHkgdGhhdCBkb2VzIG5vdCBjb2xsaWRlIGJ1dCBvdmVybGFwXG4gICAgICAgIC8vU28gaXQgbXVzdCBiZSBmbGFnZ2VkIGFzIHRyaWdnZXIsIGFuZCBub3JtYWxseSBpbiBnYW1lcyBpdCdzIGludmlzYmxlLCBzbyBpdCBoYXMgbm8gbWVzaCBjb21wb25lbnQgb3IgaXMgZnVsbHkgdHJhbnNwYXJlbnQuXG4gICAgICAgIC8vQSB1c2UgY2FzZSBpcyBzb21ldGhpbmcgbGlrZSBzcGF3bmluZyBlbmVtaWVzIHdoZW4gYSBwbGF5ZXIgZW50ZXJzIGEgcm9vbS5cbiAgICAgICAgYm9kaWVzWzNdID0gY3JlYXRlQ29tcGxldGVOb2RlKFwiVHJpZ2dlcl9CdXR0b25cIiwgbmV3IGYuTWF0ZXJpYWwoXCJUcmlnZ2VyX0J1dHRvblwiLCBmLlNoYWRlckZsYXQsIG5ldyBmLkNvYXRDb2xvcmVkKG5ldyBmLkNvbG9yKDAuNSwgMC4zLCAwLjIsIDAuMykpKSwgbmV3IGYuTWVzaEN1YmUoKSwgMSwgZi5QSFlTSUNTX1RZUEUuU1RBVElDLCBmLlBIWVNJQ1NfR1JPVVAuREVGQVVMVCk7XG4gICAgICAgIGJvZGllc1szXS5tdHhMb2NhbC50cmFuc2xhdGUobmV3IGYuVmVjdG9yMygzLCAxLCAwKSk7XG4gICAgICAgIGJvZGllc1szXS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmlzVHJpZ2dlciA9IHRydWU7XG4gICAgICAgIGhpZXJhcmNoeS5hcHBlbmRDaGlsZChib2RpZXNbM10pO1xuXG4gICAgICAgIC8vVHJpZ2dlciB3aGVuIHBsYXllciBpcyBmYWxsaW5nIG9mIHRoZSBwbGFuZVxuICAgICAgICBib2RpZXNbNF0gPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJUcmlnZ2VyX1Jlc2V0XCIsIG5ldyBmLk1hdGVyaWFsKFwiVHJpZ2dlcl9SZXNldFwiLCBmLlNoYWRlckZsYXQsIG5ldyBmLkNvYXRDb2xvcmVkKG5ldyBmLkNvbG9yKDAuNSwgMC4zLCAwLjIsIDAuMykpKSwgbmV3IGYuTWVzaEN1YmUoKSwgMSwgZi5QSFlTSUNTX1RZUEUuU1RBVElDLCBmLlBIWVNJQ1NfR1JPVVAuREVGQVVMVCk7XG4gICAgICAgIGJvZGllc1s0XS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmlzVHJpZ2dlciA9IHRydWU7XG4gICAgICAgIGJvZGllc1s0XS5yZW1vdmVDb21wb25lbnQoYm9kaWVzWzRdLmdldENvbXBvbmVudChmLkNvbXBvbmVudE1lc2gpKTsgLy9yZW1vdmluZyB0aGUgbWVzaCB0byBoYXZlIGludmlzaWJsZSB0cmlnZ2VyIC0gc3RhbmRhcmQgcHJhY3RpY2VcbiAgICAgICAgYm9kaWVzWzRdLm10eExvY2FsLnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDAsIC00LCAwKSk7XG4gICAgICAgIGJvZGllc1s0XS5tdHhMb2NhbC5zY2FsZShuZXcgZi5WZWN0b3IzKDMwLCAxLCAzMCkpOyAvL01ha2UgaXQgYmlnIGVub3VnaCBzbyB0aGUgcGxheWVyIHNob3VsZCBoaXQgaXRcbiAgICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGJvZGllc1s0XSk7XG5cbiAgICAgICAgLy9TdGVwIDMgLSBBZnRlciBjcmVhdGluZyBvdXIgUGh5c2ljIEV2ZW50IEJvZGllcywgd2UgdGVsbCB0aGVtIHRvIGxpc3RlbiB0byB0aGUgc3BlY2lmaWMgZXZlbnQgaGFwcGVuaW5nXG4gICAgICAgIC8vVGhlc2UgZXZlbnRzIGFyZSBoYXBwZW5pbmcgb24gdGhlIHBoeXNpYyBjb21wb25lbnQgbm90IG9uIHRoZSBub2RlLiBTbyBiZSBzdXJlIHRvIGFkZCB0aGVtIHRvIHRoZSBjb21wb25lbnQgbm90IHRvIHRoZSBub2RlXG4gICAgICAgIC8vQSBib2R5IGNhbiByZWNlaXZlIGEgZW50ZXIvZXhpdCBldmVudCwgYW5kIGl0J3Mgb25seSBoYXBwZW5pbmcgb25jZS4gSWYgYSBib2R5IGlzIHN0YXlpbmcgb24gYSBjb2xsaXNpb24gb3IgaW4gYSB0cmlnZ2VyIGl0IG5lZWRzIHRvIGJlIGhhbmRsZWQgbWFudWFsbHlcbiAgICAgICAgYm9kaWVzWzJdLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuYWRkRXZlbnRMaXN0ZW5lcihmLkVWRU5UX1BIWVNJQ1MuQ09MTElTSU9OX0VOVEVSLCBobmRDb2xsaXNpb25FdmVudEVudGVyKTtcbiAgICAgICAgYm9kaWVzWzJdLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuYWRkRXZlbnRMaXN0ZW5lcihmLkVWRU5UX1BIWVNJQ1MuQ09MTElTSU9OX0VYSVQsIGhuZENvbGxpc2lvbkV2ZW50RXhpdCk7XG4gICAgICAgIC8qSGludDogVGhlIENvbGxpc2lvbiBFdmVudCBpcyBvbmx5IGhhcHBlbmluZyBpZiB0aGUgb2JqZWN0IGlzIGhpdHRpbmcgaXQgcGh5c2ljYWxseSwgXG4gICAgICAgICAgU28gS0lORU1BVElDIHZzLiBTVEFUSUMgZG9lcyBub3QgcmVjZWl2ZSBhIGNvbGxpc2lvbiBFdmVudC4gT25seSBEWU5BTUlDIHZzLiBEWU5BTUlDL1NUQVRJQy9LSU5FTUFUSUMsIG5laXRoZXIgZG8gdHdvIEtpbmVtYXRpYyBoaXQgZWFjaCBvdGhlciBub3IgZG8gS2luZW1hdGljL1N0YXRpYy5cbiAgICAgICAgICBJZiB5b3UgcmVhbGx5IG5lZWQgYSBraW5lbWF0aWMgaGl0dGluZyBhIHN0YXRpYyBvYmplY3QgYW5kIHN0aWxsIGhhdmUgYSBhY3Rpb24sIHVzZSB0cmlnZ2VyLCBvciBtYWtlIHRoZSBvYmplY3Qgbm90IHN0YXRpYyBidXQgZHluYW1pYyBidXQgdW5tb3ZpbmcgYnkgaGF2aW5nIGEgcmlkaWN1bG91c2x5IGhpZ2ggd2VpZ2h0LlxuICAgICAgICAgIFRoYXRzIHdoeSB3ZSB1c2UgYSBkeW5hbWljIHBsYXllciBjdWJlIGluc3RlYWQgb2YgYSBraW5lbWF0aWMgbGlrZSB3ZSBkaWQgaW4gTGVzc29uIDEuXG4gICAgICAgICovXG5cbiAgICAgICAgLy9TYW1lIGFzIGZvciBjb2xsaXNpb24gYSB0cmlnZ2VyIGlzIGFsc28gbGlzdGVuaW5nIG9uIGEgZXZlbnQgdHlwZSBpbiBmb3JtIG9mIGYuRVZFTlRfUEhZU0lDUyBhbmQgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkXG4gICAgICAgIGJvZGllc1szXS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmFkZEV2ZW50TGlzdGVuZXIoZi5FVkVOVF9QSFlTSUNTLlRSSUdHRVJfRU5URVIsIGhuZFRyaWdnZXJFdmVudEVudGVyKTtcbiAgICAgICAgYm9kaWVzWzNdLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuYWRkRXZlbnRMaXN0ZW5lcihmLkVWRU5UX1BIWVNJQ1MuVFJJR0dFUl9FWElULCBobmRUcmlnZ2VyRXZlbnRFeGl0KTtcblxuICAgICAgICAvL1NldHRpbmcgdXAgb3VyIHJlc2V0XG4gICAgICAgIGJvZGllc1s0XS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmFkZEV2ZW50TGlzdGVuZXIoZi5FVkVOVF9QSFlTSUNTLlRSSUdHRVJfRU5URVIsIGhuZFJlc2V0VHJpZ2dlcik7XG4gICAgICAgIC8vI2VuZHJlZ2lvbiBQSFlTSUNTXG5cblxuICAgICAgICAvL1N0YW5kYXJkIEZ1ZGdlIFNjZW5lIEluaXRpYWxpemF0aW9uIC0gQ3JlYXRpbmcgYSBkaXJlY3Rpb25hbCBsaWdodCwgYSBjYW1lcmEgYW5kIGluaXRpYWxpemUgdGhlIHZpZXdwb3J0XG4gICAgICAgIGxldCBjbXBMaWdodDogZi5Db21wb25lbnRMaWdodCA9IG5ldyBmLkNvbXBvbmVudExpZ2h0KG5ldyBmLkxpZ2h0RGlyZWN0aW9uYWwoZi5Db2xvci5DU1MoXCJXSElURVwiKSkpO1xuICAgICAgICBjbXBMaWdodC5tdHhQaXZvdC5sb29rQXQobmV3IGYuVmVjdG9yMygwLjUsIC0xLCAtMC44KSk7IC8vU2V0IGxpZ2h0IGRpcmVjdGlvblxuICAgICAgICBoaWVyYXJjaHkuYWRkQ29tcG9uZW50KGNtcExpZ2h0KTtcblxuICAgICAgICBsZXQgY21wQ2FtZXJhOiBmLkNvbXBvbmVudENhbWVyYSA9IG5ldyBmLkNvbXBvbmVudENhbWVyYSgpO1xuICAgICAgICBjbXBDYW1lcmEuY2xyQmFja2dyb3VuZCA9IGYuQ29sb3IuQ1NTKFwiR1JFWVwiKTtcbiAgICAgICAgY21wQ2FtZXJhLm10eFBpdm90LnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDIsIDMuNSwgMTcpKTsgLy9Nb3ZlIGNhbWVyYSBmYXIgYmFjayBzbyB0aGUgd2hvbGUgc2NlbmUgaXMgdmlzaWJsZVxuICAgICAgICBjbXBDYW1lcmEubXR4UGl2b3QubG9va0F0KGYuVmVjdG9yMy5aRVJPKCkpOyAvL1NldCB0aGUgY2FtZXJhIG1hdHJpeCBzbyB0aGF0IGl0IGxvb2tzIGF0IHRoZSBjZW50ZXIgb2YgdGhlIHNjZW5lXG5cbiAgICAgICAgdmlld1BvcnQgPSBuZXcgZi5WaWV3cG9ydCgpOyAvL0NyZWF0aW5nIGEgdmlld3BvcnQgdGhhdCBpcyByZW5kZXJlZCBvbnRvIHRoZSBodG1sIGNhbnZhcyBlbGVtZW50XG4gICAgICAgIHZpZXdQb3J0LmluaXRpYWxpemUoXCJWaWV3cG9ydFwiLCBoaWVyYXJjaHksIGNtcENhbWVyYSwgYXBwKTsgLy9pbml0aWFsaXplIHRoZSB2aWV3cG9ydCB3aXRoIHRoZSByb290IG5vZGUsIGNhbWVyYSBhbmQgY2FudmFzXG5cbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXByZXNzXCIsIGhuZEtleSk7IC8vQWRkaW5nIGEgbGlzdGVuZXIgZm9yIGtleXByZXNzIGhhbmRsaW5nXG5cbiAgICAgICAgLy9QSFlTSUNTIC0gU3RhcnQgdXNpbmcgcGh5c2ljcyBieSB0ZWxsaW5nIHRoZSBwaHlzaWNzIHRoZSBzY2VuZSByb290IG9iamVjdC4gUGh5c2ljcyB3aWxsIHJlY2FsY3VsYXRlIGV2ZXJ5IHRyYW5zZm9ybSBhbmQgaW5pdGlhbGl6ZVxuICAgICAgICBmLlBoeXNpY3MuYWRqdXN0VHJhbnNmb3JtcyhoaWVyYXJjaHkpO1xuXG4gICAgICAgIC8vSW1wb3J0YW50IHN0YXJ0IHRoZSBnYW1lIGxvb3AgYWZ0ZXIgc3RhcnRpbmcgcGh5c2ljcywgc28gcGh5c2ljcyBjYW4gdXNlIHRoZSBjdXJyZW50IHRyYW5zZm9ybSBiZWZvcmUgaXQncyBmaXJzdCBpdGVyYXRpb25cbiAgICAgICAgZi5Mb29wLmFkZEV2ZW50TGlzdGVuZXIoZi5FVkVOVC5MT09QX0ZSQU1FLCB1cGRhdGUpOyAvL1RlbGwgdGhlIGdhbWUgbG9vcCB0byBjYWxsIHRoZSB1cGRhdGUgZnVuY3Rpb24gb24gZWFjaCBmcmFtZVxuICAgICAgICBmLkxvb3Auc3RhcnQoKTsgLy9TdGFyZCB0aGUgZ2FtZSBsb29wXG4gICAgfVxuXG4gICAgLy9GdW5jdGlvbiB0byBhbmltYXRlL3VwZGF0ZSB0aGUgRnVkZ2Ugc2NlbmUsIGNvbW1vbmx5IGtub3duIGFzIGdhbWVsb29wXG4gICAgZnVuY3Rpb24gdXBkYXRlKCk6IHZvaWQge1xuICAgICAgICBmLlBoeXNpY3Mud29ybGQuc2ltdWxhdGUoKTsgLy9QSFlTSUNTIC0gU2ltdWxhdGUgcGh5c2ljYWwgY2hhbmdlcyBlYWNoIGZyYW1lLCBwYXJhbWV0ZXIgdG8gc2V0IHRpbWUgYmV0d2VlbiBmcmFtZXNcbiAgICAgICAgdmlld1BvcnQuZHJhdygpOyAvLyBEcmF3IHRoZSBjdXJyZW50IEZ1ZGdlIFNjZW5lIHRvIHRoZSBjYW52YXNcbiAgICB9XG5cbiAgICAvLyBGdW5jdGlvbiB0byBxdWlja2x5IGNyZWF0ZSBhIG5vZGUgd2l0aCBtdWx0aXBsZSBuZWVkZWQgRnVkZ2VDb21wb25lbnRzLCBpbmNsdWRpbmcgYSBwaHlzaWNzIGNvbXBvbmVudFxuICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbXBsZXRlTm9kZShfbmFtZTogc3RyaW5nLCBfbWF0ZXJpYWw6IGYuTWF0ZXJpYWwsIF9tZXNoOiBmLk1lc2gsIF9tYXNzOiBudW1iZXIsIF9waHlzaWNzVHlwZTogZi5QSFlTSUNTX1RZUEUsIF9ncm91cDogZi5QSFlTSUNTX0dST1VQID0gZi5QSFlTSUNTX0dST1VQLkRFRkFVTFQsIF9jb2xUeXBlOiBmLkNPTExJREVSX1RZUEUgPSBmLkNPTExJREVSX1RZUEUuQ1VCRSk6IGYuTm9kZSB7XG4gICAgICAgIGxldCBub2RlOiBmLk5vZGUgPSBuZXcgZi5Ob2RlKF9uYW1lKTsgLy9DcmVhdGluZyB0aGUgbm9kZVxuICAgICAgICBsZXQgY21wTWVzaDogZi5Db21wb25lbnRNZXNoID0gbmV3IGYuQ29tcG9uZW50TWVzaChfbWVzaCk7IC8vQ3JlYXRpbmcgYSBtZXNoIGZvciB0aGUgbm9kZVxuICAgICAgICBsZXQgY21wTWF0ZXJpYWw6IGYuQ29tcG9uZW50TWF0ZXJpYWwgPSBuZXcgZi5Db21wb25lbnRNYXRlcmlhbChfbWF0ZXJpYWwpOyAvL0NyZWF0aW5nIGEgbWF0ZXJpYWwgZm9yIHRoZSBub2RlXG4gICAgICAgIGxldCBjbXBUcmFuc2Zvcm06IGYuQ29tcG9uZW50VHJhbnNmb3JtID0gbmV3IGYuQ29tcG9uZW50VHJhbnNmb3JtKCk7ICAvL1RyYW5zZm9ybSBob2xkaW5nIHBvc2l0aW9uL3JvdGF0aW9uL3NjYWxpbmcgb2YgdGhlIG5vZGVcblxuICAgICAgICBsZXQgY21wUmlnaWRib2R5OiBmLkNvbXBvbmVudFJpZ2lkYm9keSA9IG5ldyBmLkNvbXBvbmVudFJpZ2lkYm9keShfbWFzcywgX3BoeXNpY3NUeXBlLCBfY29sVHlwZSwgX2dyb3VwKTsgLy88LS0gYWRkaW5nIHRoZSBncm91cCB3aGVuIHVzaW5nIHRyaWdnZXJzLCBzaW5jZSBhIHRyaWdnZXIgc2hvdWxkIG5vdCBjb2xsaWRlIHdpdGggYW55dGhpbmcgZWxzZVxuXG4gICAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcE1lc2gpO1xuICAgICAgICBub2RlLmFkZENvbXBvbmVudChjbXBNYXRlcmlhbCk7XG4gICAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcFRyYW5zZm9ybSk7XG4gICAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcFJpZ2lkYm9keSk7IC8vIDwtLSBiZXN0IHByYWN0aWNlIHRvIGFkZCBwaHlzaWNzIGNvbXBvbmVudCBsYXN0XG4gICAgICAgIHJldHVybiBub2RlOyAvL3JldHVybiB0aGUgZnVsbCBjcmVhdGVkIG5vZGVcbiAgICB9XG5cbiAgICAvLyBFdmVudCBGdW5jdGlvbiBoYW5kbGluZyBrZXlib2FyZCBpbnB1dCAtIHNpbWlsYXIgdG8gTGVzc29uIDEgYnV0IGEgbGl0dGxlIGRpZmZlcmVudCwgc2luY2UgaXQncyBwdXNoaW5nIHRoZSBwbGF5ZXIgYnkgZm9yY2VcbiAgICBmdW5jdGlvbiBobmRLZXkoX2V2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgICAgIGxldCBob3Jpem9udGFsOiBudW1iZXIgPSAwOyAgLy9sZWZ0L3JpZ2h0XG4gICAgICAgIGxldCB2ZXJ0aWNhbDogbnVtYmVyID0gMDsgLy9mcm9udC9iYWNrXG4gICAgICAgIGxldCBoZWlnaHQ6IG51bWJlciA9IDA7IC8vdXB3YXJkcy9kb3dud2FyZHNcblxuICAgICAgICAvL0NoZWNrIGtleWJvYXJkIGlucHV0IGZyb20gRXZlbnRcbiAgICAgICAgaWYgKF9ldmVudC5jb2RlID09IGYuS0VZQk9BUkRfQ09ERS5BKSB7XG4gICAgICAgICAgICBob3Jpem9udGFsIC09IGZvcmNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChfZXZlbnQuY29kZSA9PSBmLktFWUJPQVJEX0NPREUuRCkge1xuICAgICAgICAgICAgaG9yaXpvbnRhbCArPSBmb3JjZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoX2V2ZW50LmNvZGUgPT0gZi5LRVlCT0FSRF9DT0RFLlcpIHtcbiAgICAgICAgICAgIHZlcnRpY2FsIC09IGZvcmNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChfZXZlbnQuY29kZSA9PSBmLktFWUJPQVJEX0NPREUuUykge1xuICAgICAgICAgICAgdmVydGljYWwgKz0gZm9yY2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF9ldmVudC5jb2RlID09IGYuS0VZQk9BUkRfQ09ERS5TUEFDRSkgeyAvL0p1bXBcbiAgICAgICAgICAgIGhlaWdodCArPSBmb3JjZSAqIDEwO1xuICAgICAgICB9XG4gICAgICAgIHBsYXllckJvZHkuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KS5hcHBseUxpbmVhckltcHVsc2UobmV3IGYuVmVjdG9yMyhob3Jpem9udGFsLCBoZWlnaHQsIHZlcnRpY2FsKSk7XG4gICAgfVxuXG5cbiAgICAvL1N0ZXAgNCAtIFJlY2VpdmluZyBhbmQgaGFuZGxpbmcgdGhlIGV2ZW50c1xuICAgIC8vRXZlbnQgZnVuY3Rpb24gaGFuZGxpbmcgY29sbGlzaW9uIC0gQSBFVkVOVF9QSFlTSUNTIGlzIHJlY2VpdmluZyBhIGYuRXZlbnRQaHlzaWNzIHdpdGggaW5mb3MgYWJvdXQgdGhlIGV2ZW50XG4gICAgZnVuY3Rpb24gaG5kQ29sbGlzaW9uRXZlbnRFbnRlcihfZXZlbnQ6IGYuRXZlbnRQaHlzaWNzKTogdm9pZCB7XG4gICAgICAgIC8vX2V2ZW50LiBrZWVwcyBhIHBsZXRob3JhIG9mIGluZm9ybWF0aW9ucyBhYm91dCB0aGUgZXZlbnQgdGhlIG1vc3QgaW50ZXJlc3RpbmcgYXJlIHRoaW5ncyBsaWtlIFxuICAgICAgICAvKiBcbiAgICAgICAgICBfZXZlbnQuY21wUmlnaWRib2R5IC0+IHRvIGlkZW50aWZ5IHRoZSBib2R5IGludm9sdmVkIGluIHRoZSBldmVudCwgd2l0aCBnZXRDb250YWluZXIoKS5uYW1lIHlvdSBnZXQgdGhlIGFjdHVhbCBuYW1lIG9mIHRoZSBub2RlIGludm9sdmVkIFxuICAgICAgICAgIF9ldmVudC5ub3JtYWxJbXB1bHNlIC0+IGludGVuc2l0eSBvZiB0aGUgY29sbGlzaW9uIGdvb2QgdG8gcGxheSBhIHNvdW5kIHRoYXQgaXMgb25seSBhcyBoZWF2eSBhcyB0aGUgY29sbGlzaW9uXG4gICAgICAgICAgX2V2ZW50LmNvbGxpc2lvblBvaW50IC0+IHRoZSBwb2ludCBpbiB0aGUgd29ybGQgd2hlcmUgdGhlIGNvbGxpc2lvbiBpcyBoYXBwZW5pbmcgdG8gbWF5YmUgc3Bhd24gdGhpbmdzIGxpa2UgcGFydGljbGVzXG4gICAgICAgICAgX2V2ZW50LmNvbGxpc2lvbk5vcm1hbCAtPiB0aGUgZGlyZWN0aW9uIHRoZSBjb2xsaXNpb24gaXMgaGFwcGVuaW5nIG9mdGVuIHVzZWQgdG8gY29ycmVjdGx5IHJvdGF0ZSBzcGF3bmVkIHRoaW5ncyBvbiB0aGUgY29sbGlkaW5nIHN1cmZhY2VcbiAgICAgICAgKi9cbiAgICAgICAgaWYgKF9ldmVudC5jbXBSaWdpZGJvZHkuZ2V0Q29udGFpbmVyKCkubmFtZSA9PSBcIlBsYXllclwiKSB7IC8vT3VyIEV2ZW50IGlzIGhhcHBlbmluZyB3aXRoIHRoZSBib2R5IE5PREUgY2FsbGVkIFwiUGxheWVyXCJcbiAgICAgICAgICAgIGYuRGVidWcubG9nKFwiUGxheWVyIGhpdCBtZSAtIENvbGxpZGVyXCIpO1xuICAgICAgICAgICAgLy9XZSBsZXQgdGhpcyBjb2xsaWRlciBhY3QgbGlrZSBhIGJ1bXBlciB0aHJvdWdoIHRoaXMgZXZlbnQuIFdlIHRha2UgdGhlIGV2ZW50IG5vcm1hbCBhbmQgc2hvb3QgdGhlIHBsYXllciBhd2F5IGZyb20gdGhlIGJ1bXBlciBvbiB0aGUgY29udGFjdCBwb2ludC5cbiAgICAgICAgICAgIHBsYXllckJvZHkuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KS5hcHBseUZvcmNlQXRQb2ludChuZXcgZi5WZWN0b3IzKF9ldmVudC5jb2xsaXNpb25Ob3JtYWwueCAqIDUwMCwgX2V2ZW50LmNvbGxpc2lvbk5vcm1hbC55ICogNTAwLCBfZXZlbnQuY29sbGlzaW9uTm9ybWFsLnogKiA1MDApLCBfZXZlbnQuY29sbGlzaW9uUG9pbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaG5kQ29sbGlzaW9uRXZlbnRFeGl0KF9ldmVudDogZi5FdmVudFBoeXNpY3MpOiB2b2lkIHtcbiAgICAgICAgaWYgKF9ldmVudC5jbXBSaWdpZGJvZHkuZ2V0Q29udGFpbmVyKCkubmFtZSA9PSBcIlBsYXllclwiKSB7XG4gICAgICAgICAgICBmLkRlYnVnLmxvZyhcIlBsYXllciBsZWZ0IG1lIC0gQ29sbGlkZXJcIik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL0V2ZW50IGZ1bmN0aW9uIGhhbmRsaW5nIHRyaWdnZXJpbmdcbiAgICBmdW5jdGlvbiBobmRUcmlnZ2VyRXZlbnRFbnRlcihfZXZlbnQ6IGYuRXZlbnRQaHlzaWNzKTogdm9pZCB7XG4gICAgICAgIGlmIChfZXZlbnQuY21wUmlnaWRib2R5LmdldENvbnRhaW5lcigpLm5hbWUgPT0gXCJQbGF5ZXJcIikge1xuICAgICAgICAgICAgZi5EZWJ1Zy5sb2coXCJQbGF5ZXIgZW50ZXJlZCBtZSAtIFRyaWdnZXJcIik7XG4gICAgICAgICAgICBwbGF5ZXJCb2R5LmdldENvbXBvbmVudChmLkNvbXBvbmVudE1hdGVyaWFsKS5tYXRlcmlhbCA9IHBsYXllclRyaWdnZXJlZE1hdDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGhuZFRyaWdnZXJFdmVudEV4aXQoX2V2ZW50OiBmLkV2ZW50UGh5c2ljcyk6IHZvaWQge1xuICAgICAgICBpZiAoX2V2ZW50LmNtcFJpZ2lkYm9keS5nZXRDb250YWluZXIoKS5uYW1lID09IFwiUGxheWVyXCIpIHtcbiAgICAgICAgICAgIGYuRGVidWcubG9nKFwiUGxheWVyIGxlZnQgbWUgLSBUcmlnZ2VyXCIpO1xuICAgICAgICAgICAgcGxheWVyQm9keS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRNYXRlcmlhbCkubWF0ZXJpYWwgPSBwbGF5ZXJEZWZhdWx0TWF0O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9TaW5jZSB0aGUgcGxheWVyIGNvdWxkIGZhbGwgb2Ygd2Ugd2lsbCByZXNldCBoaW0gYmFjayB3aXRoIGEgdHJpZ2dlciB3aGVuIGhlIGZhbGxzIGRvd24gZnJvbSB0aGUgcGxhbmVcbiAgICBmdW5jdGlvbiBobmRSZXNldFRyaWdnZXIoX2V2ZW50OiBmLkV2ZW50UGh5c2ljcyk6IHZvaWQge1xuICAgICAgICBpZiAoX2V2ZW50LmNtcFJpZ2lkYm9keS5nZXRDb250YWluZXIoKS5uYW1lID09IFwiUGxheWVyXCIpIHtcbiAgICAgICAgICAgIHBsYXllckJvZHkuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KS5zZXRQb3NpdGlvbihuZXcgZi5WZWN0b3IzKDAsIDMsIDApKTsgLy9TaW5jZSBpdCdzIGEgcGh5c2ljcyBib2R5IHdlIGhhdmUgdG8gc2V0IHBvc2l0aW9uIHRocm91Z2ggcGh5c2ljcyBub3QgdHJhbnNmb3JtXG4gICAgICAgIH1cbiAgICB9XG5cbn0iXX0=